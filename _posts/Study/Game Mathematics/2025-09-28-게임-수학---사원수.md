---
title: 게임 수학 - 사원수
date: 2025-09-28 
categories: [Study, Game Mathematics]
tags: [Game Engineering, Game Mathematics, Unity, Unreal,  quaternion, 게임공학, 게임수학, 유니티, 언리얼, 사원수]
pin: false
math: true
image:
  path: https://imgur.com/lUpsAQ9.jpg
---

## 1. 회전표현의 종류

---

- 오일러각(Euler angles)
  - 3차원 유클리드 공간에서의 리지드바디(rigid body)의 기울기를 각 회전축을 중심으로 하는 세개의 각도를 조합해 나타낸 것
  - 행렬의 곱셈에서는 교환 법칙이 성립하지 않으므로 3차원 회전 행렬을 여러 개 합성할 경우 다른 회전축이 포함되어 있으면 곱하는 순서에 따라 만들어지는 회전이 달라짐
  - 용어
    - 롤(roll) : 앞뒤축 회전
    - 피치(pitch) : 수평축 회전
    - 요(yaw) : 수직축 회전
  - 유니티의 `Quaternion` 클래스의 `Euler` 메소드는 $z$,$y$,$x$ 순서로 회전을 생성

- 로드리게스 회전 공식(Rodrigues’s rotation formula)
  - 임의축 중심으로 회전을 표현하는 식
  - 회전 대상의 벡터를 회전축 벡터에 평행인 성분과 수직인 성분으로 분해하여, 수직 성분만을 2차원 부분 공간(subspace) 상에서 회전시킨 다음 합성
  - 벡터 $\mathbf{v}$를 단위벡터 $\mathbf{u}$를 축으로 각도 $\theta$만큼 회전시킨 벡터 $\mathbf{w}$
  
  $$
  \mathbf{w}=\mathbf{v}\cos\theta+(\mathbf{u\times{v}})\sin\theta+(\mathbf{u\cdot{v}})(1-\cos\theta)\mathbf{u}
  $$
  
  - 오일러-로드리게스 공식(Euler-Rodrigues formula)
    - 오일러 매개변수(Euler parameters)라는 수치를 적용해 회전을 구함
  
    $$
    a^2+b^2+c^2+d^2=1
    $$
  
    - 단위벡터 $\mathbf{u}=(u_x,u_y,u_z)$를 축으로 해서 각도 $\theta$만큼 회전시켰을 때
  
    $$
    a=\cos(\dfrac{\theta}{2})\\
    b=\sin(\dfrac{\theta}{2})\\
    c=\sin(\dfrac{\theta}{2})\\
    d=\sin(\dfrac{\theta}{2})
    $$
  
    - 회전축 벡터 $\mathbf{e}$는 다음과 같다고 가정
  
    $$
    \mathbf{e}=(u_x\sin(\dfrac{\theta}{2}),u_y\sin(\dfrac{\theta}{2}),u_z\sin(\dfrac{\theta}{2}))
    $$

- 짐벌락(gimbal lock)
  - 3축의 자유도(**DOF**)로 회전하다가 첫 번째 회전과 세 번째 회전의 두 개 축이 거의 일치하여 자유도가 2축으로 한정되는 현상
  - 오일러 각 $\alpha,\beta,\gamma$일 때 회전행렬 $\mathbf{R}$은 다음과 같음
  
  $$
  \mathbf{R}=\begin{bmatrix}
  \cos\alpha\cos\gamma-\sin\alpha\cos\beta\sin\gamma & -\cos\alpha\sin\gamma-\sin\alpha\cos\beta\cos\gamma & \sin\alpha\sin\beta\\
  \sin\alpha\cos\gamma+\cos\alpha\cos\beta\sin\gamma & -\sin\alpha\sin\gamma+\cos\alpha\cos\beta\cos\gamma & -\cos\alpha\sin\beta\\
  \sin\beta\sin\gamma & \sin\beta\cos\gamma & \cos\beta
  \end{bmatrix}
  $$
  
  여기서 $\beta$가 0˚나 360˚일 때는 $\sin\beta=0,\cos\beta=1$이 됨
  
  $$
  \begin{aligned}
  \mathbf{R}&=\begin{bmatrix}
  \cos\alpha\cos\gamma-\sin\alpha\sin\gamma & -\cos\alpha\sin\gamma-\sin\alpha\cos\gamma & 0\\
  \sin\alpha\cos\gamma+\cos\alpha\sin\gamma & -\sin\alpha\sin\gamma+\cos\alpha\cos\gamma & 0\\
  0 & 0 & 1
  \end{bmatrix}\\
  &=\begin{bmatrix}
  \cos(\alpha+\gamma) & -\sin(\alpha+\gamma) & 0\\
  \sin(\alpha+\gamma) & \cos(\alpha+\gamma) & 0\\
  0 & 0 & 1
  \end{bmatrix}
  \end{aligned}
  $$
  
  - 이것은 $\alpha$와 $\gamma$에 따른 $z$ 축 회전에 지나지 않으므로, $x$ 축에서의 회전을 표현할 수 없으며 이러한 $\beta=0$을 특이점(singularity)라고 함
  
- 회전 행렬 문제
  - 회전 행렬을 사용해서 회전할 경우 짐벌락이 발생할 때 한 번 더 다른 회전 행렬을 합성하면 되지만 행렬 계산 자체에 의한 바람직하지 않은 부작용이 발생
    1. 부동소수점 연산에서 발생하는 오차
    2. 3D 모델 애니메이션 등에 사용되는 $3\times3$ 회전 행렬이 차지맣는 메모리가 무거움
    3. 축이 다른 두 개의 회전 행렬이 있을 때, 한 쪽에서 다른 쪽으로 회전하는 보간을 사용할 수 없음
    4. $x, y, z$ 축이 아닌 임의축을 중심으로 하는 회전도 행렬 표현이 매우 복잡해짐

- 사원수(Quaternion)의 장점
  - 오일러각과 행렬에 의한 회전 표현에서 일어날 수 있는 여러 문제를 해결하고 3차원 공간에서의 회전을 표현하고자 도입
    1. 짐벌락이 발생하지 않음
    2. 행렬보다 점유 메모리 영역이 작고 부하도 낮음
    3. $x, y, z$ 축에 국한되지 않는 임의의 회전축에서의 회전을 손쉽게 할 수 있음
    4. 회전을 간단히 합성할 수 있고 오차도 쉽게 발생하지 않음
    5. 두 개 회전 사이의 매끄러운 보간을 표현할 수 있음
  - 단, 오일러각은 세 개 각도의 조합이라는 단순하고 인간이 이해할 수 있는 수치로 회전을 표현할 수 있는 장점은 있음
  - 따라서 유니티 `Inspector`에서는 오일러각으로 표시하고 내부에서는 항상 사원수로 정리함
  - 모델 뷰 변환 행렬로서 유니티에서 GPU상의 셰이더에 전달될 때는 회전은 행렬로 변환됨

## 2. 사원수의 정의

---

- 복소수(complex number)
  - 복소수를 정의할 때는 허수단위(imaginary unit) $i=\sqrt{-1}$을 이용
  
  $$
  i^2=-1
  $$
  
  - 복소수란 실수 a, b와 허수단위 $i$를 이용하여 다음처럼 표현되는 수
  
      $$
      a+bi
      $$
  
  - 복소수 $z=x+iy$는 실수부(real part) $x$와 허수부(imaginary part) $y$의 두 개 실수를 $x$ 축, $y$ 축의 양으로 하는 2차원 평면의 직교좌표계상의 위치벡터에 대응하며 이를 복소평면(complex plane)이라 함
  
  ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/3a0ece8a-d6dd-41ef-b89f-b31a734d8fdd/Untitled.png)
  
  - 극형식(polar form)
    - 원의 반지름 $r$과 편각 $\theta$로 복소수를 나타내는 방법
  
      $$
      z=r(\cos\theta+i\sin\theta)
      $$
  
  - 복소수의 크기/노름
  
      $$
      \lvert{x+iy}\rvert=\sqrt{x^2+y^2}=r
      $$
  
  - 행렬로서 표현
  
      $$
      a+bi\leftrightarrow\begin{bmatrix}
      a & -b\\
      b & a
      \end{bmatrix}
      $$
  
    > - 유도 공식
    > $2\times2$인 단위 행렬 $\mathbf{E}$와 행렬 $\mathbf{I}$를 다음과 같다고 했을 때
    > $$
    > \begin{aligned}
    > \mathbf{E}&=\begin{bmatrix}
    > 1 & 0\\
    > 0 & 1
    > \end{bmatrix}\\
    > \mathbf{I}&=\begin{bmatrix}
    > 0 & -1\\
    > 1 & 0
    > \end{bmatrix}\\
    > \mathbf{I}^2&=\begin{bmatrix}
    > 0 & -1\\
    > 1 & 0
    > \end{bmatrix}
    > \begin{bmatrix}
    > 0 & -1\\
    > 1 & 0
    > \end{bmatrix}=
    > \begin{bmatrix}
    > -1 & 0\\
    > 0 & -1
    > \end{bmatrix}=-\mathbf{E}
    > \end{aligned}
    > $$
    > 따라서, 행렬 $\mathbf{Z}$는 실수 스칼라 $a, b$를 사용해 다음과 같이 표현
    > $$
    > \mathbf{Z}=a\mathbf{E}+b\mathbf{I}=\begin{bmatrix}
    > a & 0\\
    > 0 & a
    > \end{bmatrix}+
    > \begin{bmatrix}
    > 0 & -b\\
    > b & 0
    > \end{bmatrix}=
    > \begin{bmatrix}
    > a & -b\\
    > b & a
    > \end{bmatrix}
    > $$
  
    - $\mathbf{E}$가 실수, $\mathbf{I}$가 허수 단위에 해당할 경우 복소수에 대응
    - 일반 행렬의 법칙과 다르게 교환, 결합, 분배법칙 모두 만족함
    - 복소수 $a+bi$와 $c+di$의 곱은 다음과 같음
  
      $$
      (a+bi)(c+di)=(ac-bd)+(ad+bc)i
      $$
  
    - 극형식 $z=r(\cos\theta+i\sin\theta)$를 행렬로 바꾸면
  
      $$
      \mathbf{Z}=\begin{bmatrix}
      \cos\theta & -\sin\theta\\
      \sin\theta & \cos\theta
      \end{bmatrix}
      \begin{bmatrix}
      r & 0\\
      0 & r
      \end{bmatrix}
      $$
  
      2차원 회전 행렬을 $r$배 스케일하는 좌표 변환과 같음  
      특히 $r=1$(노름이 1)인 복소수를 사용하면 복소평면상에서의 편각 $\theta$의 회전을 복소수의 곱셈으로 표현할 수 있음
  
  - 공액(켤레, conjugate)
    - 허수부의 부호를 바꾼 것으로 별표($*$)를 이용해 표기
  
      $$
      z^*=a-bi
      $$
  
    - 복소수 $z$와 그 공액 $z^*$의 곱은 노름의 제곱과 같음
  
      $$
      zz^*=\lvert{z}\rvert^2
      $$
  
- 이원수(dual number)
  - 실수 $a, b$와 $n$이 양수인 정수일 때 $\varepsilon^\mathbf{n}=0$을 만족하는 실수가 아닌 멱영원(nilpotent element)인 $\varepsilon$(epsilon)을 조합한 수
  
    $$
    z=a+b\varepsilon
    $$
  
  - $a$를 실수부, $b$를 이원수부(dual part)라고 함
  - 행렬로서 표현
  
    $$
    \begin{aligned}
    \varepsilon=\begin{bmatrix}
    0 & 1\\
    0 & 0
    \end{bmatrix}\\
    a+b\varepsilon\leftrightarrow\begin{bmatrix}
    a & b\\
    0 & a
    \end{bmatrix}
    \end{aligned}
    $$
  
  - 환(ring)
    - 덧셈 · 곱셈이 정의되어 있는 집합에서 교환법칙, 결합법칙, 분배법칙 등을 만족하는 것
  - 체(field)
    - 환이론(ring theory)에서 실수의 집합이며 실수 안에서의 멱등원은 0 뿐임
    - 실수 이외의 집합에서는 0 이외의 멱등원이 존재할 수 있음
  - 연산은 복소수끼리 할 수 있고 곱셈의 교환, 결합, 분배법칙 성립
  
    $$
    (a+b\varepsilon)(c+d\varepsilon)=ac+(bc+ad)\varepsilon
    $$
  
    실수부는 이원수부의 영향을 받지 않음
  
- 사원수
  - 2차원 평면상의 위치를 나타낼 수 있는 복소수와 마찬가지로, 3차원 공간 내의 자표를 표현하면서 복소수처럼 다룰 수 있고자 도입된 개념
  - 사원수 $q$는 네 개의 기저를 사용하여 실수 $1$과, 복소수로부터 확장된 허수축(`imaginary axes`)으로서의, 실수가 아닌 $i, j, k$와 실수 $w, x, y, z$로 표현
  
    $$
    q=w+xi+yj+zk
    $$
  
    - $x=y=z=0$일 때 $q$는 실수(`real`)이고, $w=0$일 때 $q$는 순허수(`pure imaginary`)
    - $w$ 부분을 스칼라부(`scalar part`), $xi+yj+zj$ 부분을 벡터부(`vector part`)
  - 기저 $i, j, k$ 사이에는 다음과 같은 관계가 성립
  
    $$
    \begin{aligned}
    i^2=j^2=&k^2=ijk=1\\
    ij&=k\\
    ji&=-k\\
    jk&=i\\
    kj&=-i\\
    ki&=j\\
    ik&=-j
    \end{aligned}
    $$
  
    - 곱셈의 교환법칙이 성립하지 않음
    - 벡터의 외적과 비슷한데 외적 연산이 역사적으로 사원수의 벡터부의 성질을 바탕으로 정의되었기 때문
  - 표기
  
    $$
    q=[w\quad{x}\quad{y}\quad{z}]
    =[w\quad({x}\quad{y}\quad{z})]
    =[s\quad\mathbf{v}]
    $$
  
    - $s$는 스칼라부, $\mathbf{v}$는 벡터부를 나타냄

## 3. 사원수의 연산

---

- 스칼라배
  
  $$
  q=n[s\quad\mathbf{v}]=[ns\quad{n}\mathbf{v}]
  $$
  
- 공액
  
  $$
  q^*=[s\quad-\mathbf{v}]
  $$
  
- 크기(노름)
  
  $$
  \lvert{q}\rvert=\sqrt{s^2+\lvert{v}\rvert^2}
  $$
  
- 곱셈
  
  $$
  q_0q_1=[s_0s_1-v_0\cdot{v_1}\quad{s_0}\mathbf{v_1}+s_1\mathbf{v_0}+\mathbf{v_0}\times\mathbf{v_1}]
  $$
  
  - 곱셈의 교환법칙은 성립하지 않음
  - 사원수 $p, q,r$, 스칼라 $s$에서 분배, 결합법칙은 성립
  - 사원수 $p, q$의 곱의 공액은 다음과 같음
  
  $$
  (pq)^*=q^*p^*
  $$
  
- 단위 사원수(unit quaternion)
  - 크기가 1인 정규화된 사원수
  
  $$
  \begin{aligned}
  u&=[s\quad \mathbf{v}]\\
  \lvert{u}\rvert&=\sqrt{s^2+\lvert{\mathbf{v}}\rvert^2}=1
  \end{aligned}\\
  s^2+\lvert{\mathbf{v}}\rvert^2=1
  $$
  
  - 사원수 $q$에서 단위 사원수 $u$를 구하려면 사원수를 그 자신의 크기로 나누면 됨
  
  $$
  u=\dfrac{q}{\lvert{q}\rvert}
  $$
  
- 내적
  
  $$
  q_0\cdot{q_1}=s_0\;s_1+\mathbf{v_0}\cdot\mathbf{v_1}
  $$
  
  - 교환법칙이 성립함
  - 사원수 $p, q, r$에서 다음이 성립
  
  $$
  \begin{aligned}
  (qp)\cdot(qr)&=(q\cdot{q})(p\cdot{r})\\
  (pq)\cdot(pq)&=(p\cdot{p})(q\cdot{q})\\
  (pq)\cdot{r}&=p\cdot(rq^*)
  \end{aligned}
  $$
  
  - 성질
  
  $$
  \begin{aligned}
  q\cdot{q}&=\lvert{q}\rvert^2\\
  \lvert{pq}\rvert^2=(pq)\cdot(pq)&=(p\cdot{p})(q\cdot{q})=\lvert{p}\rvert^2\lvert{q}\rvert^2\\
  \lvert{pq}\rvert&=\lvert{p}\rvert\lvert{q}\rvert
  \end{aligned}
  $$
  
    $q$가 단위 사원수이면 다음이 성립
  
  $$
  \begin{aligned}
  (qp)\cdot(qr)&=(q\cdot{q})(p\cdot{r})=p\cdot{r}\\
  (pq)\cdot{r}&=p\cdot(rq^{-1})\\
  q\cdot{q}&=1
  \end{aligned}
  $$
  
- 역수
  
  $$
  q^{-1}=\dfrac{q^*}{\lvert{q}\rvert^2}
  $$
  
  - 단위 사원수 $u$에 대해 다음이 성립
  
  $$
  u^{-1}=u^*
  $$
  
  - 사원수와 그 역수의 곱은 벡터부가 영벡터가 됨
  
  $$
  qq^{-1}=[1\quad0]
  $$
  
    이 $[1\quad0]$이라는 실수 사원수는 단위원 사원수(`identity quaternion`)라 함  
    유니티의 `Quaternion.Identity` 는 단위원 사원수를 나타내며 회전을 사원수로 표현할 때 무회전을 나타냄
  
  $$
  \begin{aligned}
  qq^*&=(q\cdot{q})e\\
  q(\dfrac{q^*}{q\cdot{q}})&=e\\
  q(\dfrac{q^*}{\lvert{q}\rvert^2})&=e
  \end{aligned}
  $$
  
- 행렬 표현
  - 스칼라부의 기저로서의 단위원 사원수
  
    $$
    1=\begin{bmatrix}
    1 & 0 & 0 & 0\\
    0 & 1 & 0 & 0\\
    0 & 0 & 1 & 0\\
    0 & 0 & 0 & 1
    \end{bmatrix}
    $$
  
  - 실수가 아닌 $i^2=j^2=k^2=ijk=-1$을 만족하는 기저 $i,j,k$
  
    $$
    i=\begin{bmatrix}
    0 & 0 & 0 & 1\\
    0 & 0 & -1 & 0\\
    0 & 1 & 0 & 0\\
    -1 & 0 & 0 & 0\\
    \end{bmatrix}\\
    j=\begin{bmatrix}
    0 & 0 & 1 & 0\\
    0 & 0 & 0 & 1\\
    -1 & 0 & 0 & 0\\
    0 & -1 & 0 & 0\\
    \end{bmatrix}\\
    k=\begin{bmatrix}
    0 & -1 & 0 & 0\\
    1 & 0 & 0 & 0\\
    0 & 0 & 0 & 1\\
    0 & 0 & -1 & 0\\
    \end{bmatrix}
    $$

## 4. 사원수를 이용한 3D 회전

---

- 회전
  - 유니티의 `Quaternion` 클래스의 $w$는 스칼라부, $x,y,z$는 벡터부에 해당
  - 이 수치들로만은 어떤 회전인지 사람이 판단할 수 없음
  - 어떤 벡터 $\mathbf{p}$에 대해 사원수 q를 사용해 3차원 공간에서 회전시킨 벡터 $\mathbf{p}^\prime$
  
    $$
    \mathbf{p}^\prime=q\mathbf{p}q^{-1}
    $$
  
      1. 사원수를 한번 곱한 단계에서는 대상인 벡터 $\mathbf{p}^\prime$가 스칼라배가 0이 아니고 3차원 공간 밖으로 나온 상태
      2. 3차원에서는 최초의 회전과 같은 방향이 되는 회전을 오른쪽부터 더하여 4차원에서의 회전을 없앰
      3. 3차원 공간으로 $\mathbf{p}^\prime$를 되돌리고 스칼라배를 0으로 하여 순허수 사원수로서 3차원 벡터로 복귀
  - 사원수 자체는 3차원 내의 축을 중심으로 하는 평면상에서만 회전하는 것이 아니라, 4차원으로 직교하는 두 개의 평면상에서 같은 각도로 회전함 - 등각(isoclinic) 회전
  - 3차원 회전은 하나의 회전축에 대응하느 하나의 평면 위를 회전하지만, 4차원에서는 회전축은 없고 원점을 공유하는 두 개의 회전면이 있음
  - 성질
      1. 벡터의 크기를 바꾸지 않음
  
          $$
          \lvert{\mathbf{p}^\prime}\rvert=\lvert{q\mathbf{p}q^{-1}}\rvert=\lvert{q}\rvert\lvert{\mathbf{p}}\rvert\lvert{q^{-1}}\rvert
          $$
  
          $q$와 $q^{-1}$도 단위 사원수로 $\lvert{q}\rvert=\lvert{q^{-1}}\rvert=1$이므로 다음과 같음  
  
          $$
          \lvert{\mathbf{p}^\prime}\rvert=\lvert{q}\rvert\lvert{\mathbf{p}}\rvert\lvert{q^{-1}}\rvert=\lvert{\mathbf{p}}\rvert
          $$
  
      2. 변환 후 내적이 변하지 않아 각도도 바뀌지 않음
  
          $$
          \begin{aligned}
          \mathbf{p}^\prime\cdot\mathbf{r}^\prime&=(q\mathbf{p}q^{-1})\cdot(q\mathbf{r}q^{-1})\\&=(q\mathbf{p})\cdot(q\mathbf{r}q^{-1}q)\\&=(q\mathbf{p})\cdot(q\mathbf{r})\\&=(q\cdot{q})(p\cdot{r})
          \end{aligned}
          $$
  
          $q$는 단위 사원수로 $q\cdot{q}=1$이므로 다음과 같음  
  
          $$
          \mathbf{p}^\prime\cdot\mathbf{r}^\prime=(q\cdot{q})(\mathbf{p}\cdot\mathbf{r})=\mathbf{p}\cdot\mathbf{r}
          $$
  
    > 사원수에 의한 회전 증명
    > $q=[q_s\quad\mathbf{q_v}], p=[0\quad\mathbf{p_v}], p^\prime=[s\quad\mathbf{v}]$라고 했을때,
    > $$
    > \begin{aligned}
    > p^\prime&=qpq^{-1}\\
    > &=[q_s\;\mathbf{q_v}][0\;\mathbf{p_v}][q_s\;\mathbf{-q_v}]\\
    > &= [\mathbf{-q_v}\cdot\mathbf{p_v}q_s\mathbf{p_v}+\mathbf{q_v}\times\mathbf{p_v}][q_s\;\mathbf{-q_v}]\\
    > &=[-q_s(\mathbf{q_v}\cdot\mathbf{p_v})+\mathbf{q_v}\cdot(q_s\mathbf{p_v}+\mathbf{q_v}\times\mathbf{p_v})\\&(\mathbf{q_v}\cdot\mathbf{p_v})\mathbf{q_v}+q_s(q_s\mathbf{p_v}+\mathbf{q_v}\times\mathbf{p_v})-(q_s\mathbf{p_v}+\mathbf{q_v}\times\mathbf{p_v})\times\mathbf{q_v}]
    > \end{aligned}
    > $$
    > 1. $p^\prime$의 스칼라부 $s$
    > $$
    > \begin{aligned}
    > s&=-q_s(\mathbf{q_v}\cdot\mathbf{p_v})+\mathbf{q_v}\cdot(q_s\mathbf{p_v}+\mathbf{q_v}\times\mathbf{p_v})\\
    > &=-q_s(\mathbf{q_v}\cdot\mathbf{p_v})+q_s(\mathbf{q_v}\cdot\mathbf{p_v})+\mathbf{q_v}\cdot(\mathbf{q_v}\times\mathbf{p_v})\\
    > &=\mathbf{q_v}\cdot(\mathbf{q_v}\times\mathbf{p_v})
    > \end{aligned}
    > $$
    > 이때 $\mathbf{q_v}\cdot(\mathbf{q_v}\times\mathbf{p_v})$는 스칼라 삼중적이지만 안쪽 두 개 벡터가 같고 선형 종속이므로
    > $$
    > s=\mathbf{q_v}\cdot(\mathbf{q_v}\times\mathbf{p_v})=0
    > $$
    > 따라서 $p^\prime$는 순허수이고 4차원이 아니라 3차원 벡터를 나타냄
    > 2. $p^\prime$의 벡터부 $\mathbf{v}$
    > $$
    > \begin{aligned}
    > \mathbf{v}&=(\mathbf{q_v}\cdot\mathbf{p_v})\mathbf{q_v}+q_s(q_s\mathbf{q_v}+\mathbf{q_v}\times\mathbf{o_v})-(q_s\mathbf{q_v}+\mathbf{q_v}\times\mathbf{p_v})\times\mathbf{q_v}\\
    > &=(\mathbf{q_v}\cdot\mathbf{p_v})\mathbf{q_v}+q_s^2\mathbf{p_v}+q_s(\mathbf{q_v}\times\mathbf{p_v})-q_s(\mathbf{p_v}\times\mathbf{q_v})-(\mathbf{q_v}\times\mathbf{p_v})\times\mathbf{q_v}\\
    > &=(\mathbf{q_v}\cdot\mathbf{p_v})\mathbf{q_v}+q_s^2\mathbf{p_v}+q_s(\mathbf{q_v}\times\mathbf{p_v})+q_s(\mathbf{q_v}\times\mathbf{p_v})-(\mathbf{q_v}\times\mathbf{p_v})\times\mathbf{q_v}\\
    > &=(\mathbf{q_v}\cdot\mathbf{p_v})\mathbf{q_v}+q_s^2\mathbf{p_v}+2q_s(\mathbf{p_v}\times\mathbf{q_v})-(\mathbf{q_v}\times\mathbf{p_v})\times\mathbf{q_v}
    > \end{aligned}
    > $$
    > 여기서 $(\mathbf{q_v}\times\mathbf{p_v})\times\mathbf{q_v}$가 벡터 삼중적이므로 전개하면
    > $$
    > \begin{aligned}
    > \mathbf{v}&=(\mathbf{q_v}\cdot\mathbf{p_v})\mathbf{q_v}+q_s^2\mathbf{p_v}+2q_s(\mathbf{q_v}\times\mathbf{p_v})-(\mathbf{q_v}\times\mathbf{p_v})\times\mathbf{q_v}\\
    > &=(\mathbf{q_v}\cdot\mathbf{p_v})\mathbf{q_v}+q_s^2\mathbf{p_v}+2q_s(\mathbf{q_v}\times\mathbf{p_v})-(\mathbf{q_v}\cdot\mathbf{q_v})\mathbf{p_v}-(\mathbf{p_v}\cdot\mathbf{q_v})\mathbf{q_v}\\
    > &=(q_s^2-\mathbf{q_v}\cdot\mathbf{q_v})\mathbf{p_v}+2q_s(\mathbf{q_v}\times\mathbf{p_v})+2(\mathbf{q_v}\cdot\mathbf{p_v})\mathbf{q_v}
    > \end{aligned}
    > $$
    > $q$는 단위 사원수이므로 다음과 같음
    > $$
    > \begin{aligned}
    > q_s^2+\lvert\mathbf{q_v}\rvert^2&=
    > q_s^2+\mathbf{q_v}\cdot\mathbf{q_v}= 1\\
    > q_s^2&=1-\mathbf{q_v}\cdot\mathbf{q_v}
    > \end{aligned}
    > $$
    > $q_s^2=1-\mathbf{q_v}\cdot\mathbf{q_v}$를 위 식에 대입하면
    > $$
    > \begin{aligned}
    > \mathbf{v}&=(q_s^2-\mathbf{q_v}\cdot\mathbf{q_v})\mathbf{p_v}+2q_s(\mathbf{q_v}\times\mathbf{p_v})+2(\mathbf{q_v}\cdot\mathbf{p_v})\mathbf{q_v}\\
    > &=((1-\mathbf{q_v}\cdot\mathbf{q_v})-\mathbf{q_v}\cdot\mathbf{q_v})\mathbf{p_v}+2q_s(\mathbf{q_v}\times\mathbf{p_v})+2(\mathbf{q_v}\cdot\mathbf{p_v})\mathbf{q_v}\\
    > &=\mathbf{p_v}-2(\mathbf{q_v}\cdot\mathbf{q_v})\mathbf{p_v}+2q_s(\mathbf{q_v}\times\mathbf{p_v})+2(\mathbf{q_v}\cdot\mathbf{p_v})\mathbf{q_v}\\
    > &=\mathbf{p_v}+2q_s(\mathbf{q_v}\times\mathbf{p_v})+2((\mathbf{q_v}\cdot\mathbf{p_v})\mathbf{q_v}-(\mathbf{q_v}\cdot\mathbf{q_v})\mathbf{p_v}
    > \end{aligned}
    > $$
    > $(\mathbf{q_v}\cdot\mathbf{p_v})\mathbf{q_v}-(\mathbf{q_v}\cdot\mathbf{q_v})\mathbf{p_v}$는 전개된 벡터 삼중적이므로 원래의 삼중적으로 하면
    > $$
    > \mathbf{v}=\mathbf{p_v}+2q_s(\mathbf{q_v}\times\mathbf{p_v})+2(\mathbf{q_v}\times(\mathbf{q_v}\times{p}))
    > $$
    > 이 공식은 오일러-로드리게스의 회전공식과 같은 구조임
    > $$
    > \mathbf{w}=\mathbf{v}+2a(\mathbf{e}\times\mathbf{v})+2(e\times(e\times\mathbf{v}))
    > $$
    > 또한 오일러 매개변수인 $a^2+b^2+c^2+d^2=1$은 단위 사원수 노름이 만족하는 조건

    > 사원수에 의한 회전에 각도 $\theta$
    > $p$의 벡터부 $\mathbf{p_v}$와 회전 후 벡터 $\mathbf{v}$가 이루는 각도가 $\theta$이고,  $\mathbf{p_v}$가 $\mathbf{q_v}$에 수직일 때
    > $$
    > \begin{aligned}
    > \mathbf{p_v}\cdot\mathbf{v}&=\lvert\mathbf{p_v}\rvert\lvert{\mathbf{v}}\rvert\cos\theta\\
    > &=\lvert\mathbf{p_v}\rvert^2\cos\theta
    > \end{aligned}
    > $$
    > 증명에서 구한 $\mathbf{v}$의 식을 대입하면
    > $$
    > \begin{aligned}
    > \mathbf{p_v}\cdot\mathbf{v}&=\mathbf{p_v}\cdot(\mathbf{p_v}+2q_s(\mathbf{q_v}\times\mathbf{p_v})+2((\mathbf{q_v}\cdot\mathbf{p_v})\mathbf{q_v}-(\mathbf{q_v}\cdot\mathbf{q_v})\mathbf{p_v}))\\
    > &=\mathbf{p_v}\cdot\mathbf{p_v}+2q_s(\mathbf{p_v}\cdot(\mathbf{q_v}\times\mathbf{p_v}))+2(\mathbf{p_v}\cdot\mathbf{q_v})^2-2(\mathbf{q_v}\cdot\mathbf{q_v})(\mathbf{p_v}\cdot\mathbf{p_v})
    > \end{aligned}
    > $$
    > 여기서 $\mathbf{p_v}\cdot(\mathbf{q_v}\times\mathbf{p_v})$는 $\mathbf{p_v}$끼리 선형종속이므로 0이 되고 $\mathbf{p_v}$는 $\mathbf{q_v}$에 수직이므로 $\mathbf{p_v}\cdot\mathbf{q_v}=0$임
    > $$
    > \begin{aligned}
    > \mathbf{p_v}\cdot\mathbf{v}&=\mathbf{p_v}\cdot\mathbf{p_v}-2(\mathbf{q_v}\cdot\mathbf{q_v})(\mathbf{p_v}\cdot\mathbf{p_v})\\
    > &=(1-2(\mathbf{q_v}\cdot\mathbf{q_v}))\lvert\mathbf{p_v}\rvert^2
    > \end{aligned}
    > $$
    > $q$는 단위 사원수이므로 다음과 같음
    > $$
    > q_s^2+\lvert\mathbf{q_v}\rvert^2=1\\
    > q_s^2+\mathbf{q_v}\cdot\mathbf{q_v}=1
    > $$
    > $\mathbf{p_v}\cdot\mathbf{v}$ 식에서 $1$을 위 식으로 치환하면
    > $$
    > \begin{aligned}
    > \mathbf{p_v}\cdot\mathbf{v}&=(1-2(\mathbf{q_v}\cdot\mathbf{q_v}))\lvert\mathbf{p_v}\rvert^2\\
    > &=(q_s^2+\mathbf{q_v}\cdot\mathbf{q_v}-2(\mathbf{q_v}\cdot\mathbf{q_v}))\lvert\mathbf{p_v}\rvert^2\\
    > &=(q_s^2-\mathbf{q_v}\cdot\mathbf{q_v})\lvert\mathbf{p_v}\rvert^2
    > \end{aligned}
    > $$
    > $$
    > (q_s^2-\mathbf{q_v}\cdot\mathbf{q_v})\lvert\mathbf{p_v}\rvert^2=\vert\mathbf{p_v}\rvert^2\cos\theta\\
    > q_s^2-\mathbf{q_v}\cdot\mathbf{q_v}=\cos\theta
    > $$
    > 앞서 구한 $q_s^2+\mathbf{q_v}\cdot\mathbf{q_v}=1$을 더하면
    > $$
    > \begin{aligned}
    > 2(q_s^2)&=\cos\theta+1\\
    > q_s^2
    > &=\dfrac{1+\cos\theta}{2}\\
    > q_s^2&=(\cos\dfrac{\theta}{2})^2\\
    > q_s&=\pm\cos\dfrac{\theta}{2}
    > \end{aligned}
    > $$
    > 마찬가지로 $q_s^2+\mathbf{q_v}\cdot\mathbf{q_v}=1$ 빼면
    > $$
    > \begin{aligned}
    > -2\mathbf{q_v}\cdot\mathbf{q_v}&=\cos\theta-1\\
    > \lvert\mathbf{q_v}\rvert^2&=\dfrac{1-\cos\theta}{2}\\
    > &=(\sin\dfrac{\theta}{2})^2\\
    > \mathbf{q_v}&=\pm\sin\dfrac{\theta}{2}\mathbf{u}
    > \end{aligned}
    > $$
    > 따라서 3차원 회전으로서 부호에 관계없이 $q$와 $-q$는 같은 의미임
    > $$
    > (\cos\dfrac{\theta}{2})^2+(\sin\dfrac{\theta}{2})^2+(\sin\dfrac{\theta}{2})^2+(\sin\dfrac{\theta}{2})^2=1
    > $$
    > 이므로 $q_s$와 $\mathbf{q_v}$ 성분의 수치 관계는 오일러 매개변수와 같음
  
  - 정리
    - 임의의 회전축의 단위벡터 $\mathbf{u}$, 회전하는 각도를 $\theta$라고 했을 때 3차원에서의 회전은 사원수를 사용해 다음식으로 표현
  
    $$
    \begin{aligned}
    p^\prime&=qpq^{-1}\\
    q&=\begin{bmatrix}
    \cos\dfrac{\theta}{2} & \sin\dfrac{\theta}{2}\mathbf{u}
    \end{bmatrix}
    \end{aligned}
    $$
  
    - $p^\prime$를 단위 사원수 $q$로 회전한 후 다른 단위 사원수 $r$을 사용해 회전 시킬 경우 다음과 같음
  
    $$
    r(qpq^{-1})r^{-1}=(rq)p(q^*r^*)=(rq)p(rq)^*
    $$
  
      미리 사원수 $rq$를 계산해서 사원수 $s$로 합성해두면 회전을 합성할 수 있음
  
- 보간
  - 단위 사원수 $q$에 단위 사원수 $r$의 회전을 합성한 회전이 사원수 $s$라고 하면 다음이 성립
  
    $$
    \begin{aligned}
    s&=rq\\
    sq^{-1}&=r(qq^{-1})\\
    sq^{-1}&=r
    \end{aligned}
    $$
  
    $q$에서 $s$로의 회전은 사원수 $sq^{-1}$의 회전으로 나타낼 수 있음  
  
    여기서 $q=\begin{bmatrix}q_s & \mathbf{q_v}\end{bmatrix}$, $s=\begin{bmatrix}s_s&\mathbf{s_v}\end{bmatrix}$일 때 $sq^{-1}$의 스칼라부 $t$는 다음과 같음  
  
    $$
    t=s_sq_s+\mathbf{s_v}\cdot\mathbf{q_v}=s\cdot{q}
    $$
  
    따라서 $q$에서 $s$로의 회전을 나타내는 사원수의 스칼라부 $t$는 $s$와 $q$의 내적

    $q$에서 $s$로의 회전 각도가 $\theta$일 때 다음과 같음
  
    $$
    s\cdot{q}=\cos\dfrac{\theta}{2}
    $$
  
    아크 코사인을 사용하면 $\theta$의 각도를 구할 수 있음  
  
  - 선형보간(linear interpolation, `Lerp`)와 구면선형보간(spherical linear interpolation, `Slerp`)
    - 세 개의 인수를 사용하고 첫 번째가 변화 전 회전인 `from`, 두 번째가 변화 후 회전인 `to`, 세 번째가 $0\sim1$ 사이로 정규화된 변화량인 `t`
    - 한 번 호출할 때마다 $0$를 `from` 위치로, $1$를 `to`의 위치로 `t`씩 `from`에서 `to`로 변화시켜가는 것
    - `from`이 $q_1$, `to`가 $q_2$, 변화량을 `t` $[0, 1]$로 했을 때
      1. 선형보간
  
          $$
          q_1+t(q_2-q_1)
          $$
  
      2. $q_1$과 $q_2$가 이루는 각이 $\theta$일때 구면선형보간
  
          $$
          \dfrac{\sin((1-t)\theta)q_1+\sin(t\theta)q_2}{\sin\theta}
          $$
  
    - 직접 보간을 구현할 경우 주의점
      1. 3차원 회전으로서는 부호에 관계없이 $q$와 $-q$는 같은 의미지만, 4차원 공간에서는 다른 의미를 가지므로 $q_1$과 $q_2$의 내적이 마이너스일 때는 한쪽 사원수의 부호를 바꿔야함
      2. 구면선형보간의 경우, $\theta$가 극히 작아 $0$으로 간주되거나 180˚일 때는 분모인 $\sin\theta$가 $0$ 나누기 오류를 발생시키므로 피해야함

## 5. 쌍대 사원수(dual quaternion)

---

- 정의
  - 사원수의 이원수로 두 개의 사원수 $r, d$와 멱영원 $\varepsilon$을 이용해 다음과 같이 정의
  
    $$
    \hat{q}=r+d\varepsilon
    $$
  
    이때 $r$은 실수부, $d$는 이원수부이고 실질적으로는 성분이 8개인 벡터가 되고 리지드바디 변환을 표현하는 $3\times4$ 행렬보다 크기가 작아 유리함
  
- 스키닝(skinning)에 응용
  - 스키닝이란
    - 스켈레탈 애니메이션(skeletal animation) 방식에 주로 이용됨
    - 스켈레톤(skeleton)이나 본(bone), 리그(rig)라 불리는 골격 구조에 관절(joint)의 리깅(rigging)에 따라 3D 모델링 표면에 펼쳐진 스킨(skin)을 애니메이션에 따라 동기화시키는 것
  - LBS(linear blend skinning) 알고리즘
    - 복수의 관절로부터 영향을 받아 변형할 스킨상의 정점을 합계가 1이 되는 가중치의 수치와 각 관절의 좌표 변환의 선형합으로 나타내는 방식
  
      $$
      \mathbf{P^\prime}=\sum_{i=1}^{n}w_i\mathbf{M}_i\mathbf{B}_i\mathbf{P}
      $$
  
      $\mathbf{P}$ : 스킨상의 정점 좌표
  
      $\mathbf{P^\prime}$ : LBS로 변형된 스킨상의 정점 좌표
  
      $w$ : 가중치
  
      $n$ : 영향을 받는 관절 수
  
      $\mathbf{B}$ : 관절의 로컬 좌표계에서 스킨의 로컬 좌표계로의 변환 행렬
  
      $\mathbf{M}$ : 초기 상태(rest pose)의 관절 위치에서 현재 관절 위치로의 변환 행렬
  
  - 순운동학(Forward kinematics, **FK**)
    - 각 관절의 자유도를 바탕으로 부모 관절의 회전 $\theta$에 따라 자식 관절의 위치를 변화시키고, 각 관절의 상대위치에서 최정적인 본의 끝 위치가 정해지는 방식
    - LBS는 `FK`를 바탕으로 변환 행렬 $\mathbf{M}$을 계산함
  - 역운동학(`Inverse kinematics`, `IK`)
    - 목표 지점으로부터 각 관절의 자유도를 구해 자식 관절의 상태가 부모 관절의 상태를 규정함
    - 표현의 자유를 보장하고 싶은 요소마다 `IK` 시스템을 사용
    - 유니티의 `Mecanim Animator`에서 3D 모델에 휴머노이드 아바타를 설정하면 `IK` 기능을 사용할 수 있음
  - 쌍대 사원수에 의한 리지드 바디 변환을 이용한 스키닝
    - 기존의 LBS에는 가중치를 부여한 리지드바디 변환의 총합을 사용하므로, 결과인 변환 행렬이 반드시 리지드바디 변환을 나타내지는 않아, 관절 모양이 찌부러진듯 보이는 문제
    - 정점 벡터를 쌍대 사원수 $\hat{q}$의 이원부수의 사원수에 저장하고, 쌍대 사원수 $\hat{q}$에서 리지드바디 변환한 가중치 $w$로 가중합을 취하면 결과 $\hat{p}^\prime$은 항상 리지드바디 변환함
  
    $$
    \hat{p\prime}=(\sum_{i=1}^nw_i\hat{q})\hat{p}(\sum_{i=1}^nw_i\hat{q})^{-1}
    $$
  
- 연산
  
  쌍대 사원수 $\hat{q}=r+d\varepsilon$, $\hat{q_0}=r_0+d_0\varepsilon$,  $\hat{q_1}=r_1+d_1\varepsilon$, 스칼라 $s$에 대해
  
  1. 덧셈
  
      $$
      \hat{q_0}+\hat{q_1}=r_0+r_1+(d_0+d_1)\varepsilon
      $$
  
  2. 곱셈
  
      $$
      \begin{aligned}
      s\hat{q_0}&=sr_0+sd_0\varepsilon\\
      \hat{q_0}\hat{q_1}&=r_0r_1+(r_0d_1+d_0r_1)\varepsilon
      \end{aligned}
      $$
  
  3. 공액
  
      $$
      \hat{q^*}=r^*+d^*\varepsilon
      $$
  
  4. 크기
  
      $$
      \lvert{\hat{q}}\rvert=\sqrt{\hat{q}q^*}
      $$
  
  5. 단위 쌍대 사원수
  
      $$
      \begin{aligned}
      \lvert{\hat{q}}\rvert=\hat{q}q^*&=1\\
      r^*d+d^*r&=0
      \end{aligned}
      $$
  
  6. 실수부 $r\ne0$인 역수
  
      $$
      \hat{q^{-1}}=\dfrac{\hat{q^*}}{\lvert{\hat{q}}\rvert^2}
      $$
  
- 리지드바디 변환
  - $(t_x,t_y,t_z)$의 평행이동 단위 사원수 $\hat{t}$는 다음과 같음
  
  $$
  \begin{aligned}
  \hat{t}&=1+(\dfrac{t_x}{2}i+\dfrac{t_y}{2}j+\dfrac{t_z}{2}k)\epsilon\\
  &=\begin{bmatrix}1&0&0&0\end{bmatrix}\begin{bmatrix}0&\dfrac{t_x}{2}&\dfrac{t_y}{2}&\dfrac{t_z}{2}\end{bmatrix}
  \end{aligned}
  $$
  
  - 회전축의 벡터 $\mathbf{u}$, 각도를 $\theta$로 하는 회전 쌍대 사원수 $\hat{r}$은 다음과 같음
  
    $$
    \hat{r}=\begin{bmatrix}
    \cos\dfrac{\theta}{2}&\sin\dfrac{\theta}{2}u_x&\sin\dfrac{\theta}{2}u_y&\sin\dfrac{\theta}{2}u_z
    \end{bmatrix}
    \begin{bmatrix}
    0&0&0&0
    \end{bmatrix}
    $$
  
    - 단위 사원수 $r$에 의한 회전과 평행이동을 나타내는 단위 쌍대 사원수의 이원수부 $t$가 가리키는 평행이동을 합성한 쌍대 사원수 $\hat{q}$는 단위 쌍대 사원수가 되고 실수부는 $r$, 이원수부는 $tr$
    - 벡터 $\mathbf{v}=(v_x,v_y,v_z$)는 리지드바디 변환 후 쌍대 사원수 $\hat{v}$는 다음과 같음
  
    $$
    \begin{aligned}
    \hat{v}&=\begin{bmatrix}1&0&0&0\end{bmatrix}\begin{bmatrix}0&v_x&v_y&v_z\end{bmatrix}\\
    &=\hat{q}vq^*
    \end{aligned}
    $$
